"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const core_1 = require("@aws-cdk/core");
const aws_redshift_1 = require("@aws-cdk/aws-redshift");
const aws_ec2_1 = require("@aws-cdk/aws-ec2");
const aws_iam_1 = require("@aws-cdk/aws-iam");
const aws_s3_1 = require("@aws-cdk/aws-s3");
const aws_glue_1 = require("@aws-cdk/aws-glue");
const uuid_1 = require("uuid");
const dotenv = require("dotenv");
dotenv.config({ path: '../.env' });
class RedPandaTestStack extends core_1.Stack {
    constructor(scope, id) {
        super(scope, id);
        // Bucket
        const role = new aws_iam_1.Role(this, 'RedPandaTestRole', {
            assumedBy: new aws_iam_1.ServicePrincipal('redshift.amazonaws.com')
        });
        const bucket = new aws_s3_1.Bucket(this, 'RedPandaTestBaseBucket', {
            bucketName: `redpandateststack-base-${uuid_1.v4()}`,
            versioned: false,
            publicReadAccess: false,
            blockPublicAccess: aws_s3_1.BlockPublicAccess.BLOCK_ALL,
            removalPolicy: core_1.RemovalPolicy.DESTROY
        });
        bucket.grantReadWrite(role);
        // Redshift
        const vpc = new aws_ec2_1.Vpc(this, 'RedPandaTestVPC', {});
        const sg = new aws_ec2_1.SecurityGroup(this, 'RedPandaTestSecurityGroup', {
            vpc: vpc
        });
        sg.connections.allowFromAnyIpv4(aws_ec2_1.Port.tcp(5439));
        sg.node.addDependency(vpc);
        const { subnetIds } = vpc.selectSubnets({ subnetType: aws_ec2_1.SubnetType.PUBLIC });
        const subnetGroup = new aws_redshift_1.CfnClusterSubnetGroup(this, 'RedPandaTestSubnets', {
            description: `Subnets for Redshift cluster`,
            subnetIds
        });
        subnetGroup.applyRemovalPolicy(core_1.RemovalPolicy.RETAIN, {
            applyToUpdateReplacePolicy: true
        });
        const cluster = new aws_redshift_1.CfnCluster(this, 'RedPandaTestRedshift', {
            masterUsername: process.env.REDSHIFT_USERNAME || '',
            masterUserPassword: process.env.REDSHIFT_PASSWORD || '',
            dbName: process.env.REDSHIFT_DB || '',
            clusterType: 'single-node',
            port: parseInt(process.env.REDSHIFT_PORT || '5439'),
            nodeType: 'dc2.large',
            iamRoles: [role.roleArn],
            publiclyAccessible: true,
            vpcSecurityGroupIds: [sg.securityGroupId],
            clusterSubnetGroupName: subnetGroup.ref
        });
        cluster.node.addDependency(sg);
        // Glue
        const glueDB = new aws_glue_1.Database(this, 'RedPandaTestGlueDB', {
            databaseName: 'redpandatestgluedb'
        });
        const glueBucket = new aws_s3_1.Bucket(this, 'RedPandaTestGlueBucket', {
            bucketName: `redpandateststack-glue-${uuid_1.v4()}`,
            versioned: false,
            publicReadAccess: false,
            blockPublicAccess: aws_s3_1.BlockPublicAccess.BLOCK_ALL,
            removalPolicy: core_1.RemovalPolicy.DESTROY
        });
        new aws_glue_1.Table(this, 'MyTable', {
            bucket: glueBucket,
            database: glueDB,
            tableName: 'redpandatestgluetable',
            columns: [
                {
                    name: 'col0',
                    type: aws_glue_1.Schema.STRING
                },
                {
                    name: 'col1',
                    type: aws_glue_1.Schema.STRING
                }
            ],
            dataFormat: aws_glue_1.DataFormat.CSV
        });
        // Athena
        new aws_s3_1.Bucket(this, 'RedPandaTestAthenaBucket', {
            bucketName: `redpandateststack-athena-${uuid_1.v4()}`,
            versioned: false,
            publicReadAccess: false,
            blockPublicAccess: aws_s3_1.BlockPublicAccess.BLOCK_ALL,
            removalPolicy: core_1.RemovalPolicy.DESTROY
        });
    }
}
exports.RedPandaTestStack = RedPandaTestStack;
const app = new core_1.App();
new RedPandaTestStack(app, 'RedPandaTestStack');
app.synth();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHdDQUF5RDtBQUN6RCx3REFBeUU7QUFDekUsOENBQXVFO0FBQ3ZFLDhDQUF5RDtBQUN6RCw0Q0FBMkQ7QUFDM0QsZ0RBQXVFO0FBQ3ZFLCtCQUFtQztBQUNuQyxpQ0FBZ0M7QUFFaEMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFBO0FBRWxDLE1BQWEsaUJBQWtCLFNBQVEsWUFBSztJQUMxQyxZQUFZLEtBQVUsRUFBRSxFQUFVO1FBQ2hDLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUE7UUFFaEIsU0FBUztRQUNULE1BQU0sSUFBSSxHQUFHLElBQUksY0FBSSxDQUFDLElBQUksRUFBRSxrQkFBa0IsRUFBRTtZQUM5QyxTQUFTLEVBQUUsSUFBSSwwQkFBZ0IsQ0FBQyx3QkFBd0IsQ0FBQztTQUMxRCxDQUFDLENBQUE7UUFFRixNQUFNLE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQyxJQUFJLEVBQUUsd0JBQXdCLEVBQUU7WUFDeEQsVUFBVSxFQUFFLDBCQUEwQixTQUFNLEVBQUUsRUFBRTtZQUNoRCxTQUFTLEVBQUUsS0FBSztZQUNoQixnQkFBZ0IsRUFBRSxLQUFLO1lBQ3ZCLGlCQUFpQixFQUFFLDBCQUFpQixDQUFDLFNBQVM7WUFDOUMsYUFBYSxFQUFFLG9CQUFhLENBQUMsT0FBTztTQUNyQyxDQUFDLENBQUE7UUFFRixNQUFNLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFBO1FBRTNCLFdBQVc7UUFDWCxNQUFNLEdBQUcsR0FBRyxJQUFJLGFBQUcsQ0FBQyxJQUFJLEVBQUUsaUJBQWlCLEVBQUUsRUFBRSxDQUFDLENBQUE7UUFFaEQsTUFBTSxFQUFFLEdBQUcsSUFBSSx1QkFBYSxDQUFDLElBQUksRUFBRSwyQkFBMkIsRUFBRTtZQUM5RCxHQUFHLEVB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YSxDQUFDLE9BQU87U0FDckMsQ0FBQyxDQUFBO0lBQ0osQ0FBQztDQUNGO0FBN0ZELDhDQTZGQztBQUVELE1BQU0sR0FBRyxHQUFHLElBQUksVUFBRyxFQUFFLENBQUE7QUFDckIsSUFBSSxpQkFBaUIsQ0FBQyxHQUFHLEVBQUUsbUJBQW1CLENBQUMsQ0FBQTtBQUMvQyxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcHAsIFN0YWNrLCBSZW1vdmFsUG9saWN5IH0gZnJvbSAnQGF3cy1jZGsvY29yZSdcbmltcG9ydCB7IENmbkNsdXN0ZXIsIENmbkNsdXN0ZXJTdWJuZXRHcm91cCB9IGZyb20gJ0Bhd3MtY2RrL2F3cy1yZWRzaGlmdCdcbmltcG9ydCB7IFZwYywgU2VjdXJpdHlHcm91cCwgUG9ydCwgU3VibmV0VHlwZSB9IGZyb20gJ0Bhd3MtY2RrL2F3cy1lYzInXG5pbXBvcnQgeyBSb2xlLCBTZXJ2aWNlUHJpbmNpcGFsIH0gZnJvbSAnQGF3cy1jZGsvYXdzLWlhbSdcbmltcG9ydCB7IEJ1Y2tldCwgQmxvY2tQdWJsaWNBY2Nlc3MgfSBmcm9tICdAYXdzLWNkay9hd3MtczMnXG5pbXBvcnQgeyBEYXRhYmFzZSwgVGFibGUsIFNjaGVtYSwgRGF0YUZvcm1hdCB9IGZyb20gJ0Bhd3MtY2RrL2F3cy1nbHVlJ1xuaW1wb3J0IHsgdjQgYXMgdXVpZHY0IH0gZnJvbSAndXVpZCdcbmltcG9ydCAqIGFzIGRvdGVudiBmcm9tICdkb3RlbnYnXG5cbmRvdGVudi5jb25maWcoeyBwYXRoOiAnLi4vLmVudicgfSlcblxuZXhwb3J0IGNsYXNzIFJlZFBhbmRhVGVzdFN0YWNrIGV4dGVuZHMgU3RhY2sge1xuICBjb25zdHJ1Y3RvcihzY29wZTogQXBwLCBpZDogc3RyaW5nKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKVxuXG4gICAgLy8gQnVja2V0XG4gICAgY29uc3Qgcm9sZSA9IG5ldyBSb2xlKHRoaXMsICdSZWRQYW5kYVRlc3RSb2xlJywge1xuICAgICAgYXNzdW1lZEJ5OiBuZXcgU2VydmljZVByaW5jaXBhbCgncmVkc2hpZnQuYW1hem9uYXdzLmNvbScpXG4gICAgfSlcblxuICAgIGNvbnN0IGJ1Y2tldCA9IG5ldyBCdWNrZXQodGhpcywgJ1JlZFBhbmRhVGVzdEJhc2VCdWNrZXQnLCB7XG4gICAgICBidWNrZXROYW1lOiBgcmVkcGFuZGF0ZXN0c3RhY2stYmFzZS0ke3V1aWR2NCgpfWAsXG4gICAgICB2ZXJzaW9uZWQ6IGZhbHNlLFxuICAgICAgcHVibGljUmVhZEFjY2VzczogZmFsc2UsXG4gICAgICBibG9ja1B1YmxpY0FjY2VzczogQmxvY2tQdWJsaWNBY2Nlc3MuQkxPQ0tfQUxMLFxuICAgICAgcmVtb3ZhbFBvbGljeTogUmVtb3ZhbFBvbGljeS5ERVNUUk9ZXG4gICAgfSlcblxuICAgIGJ1Y2tldC5ncmFudFJlYWRXcml0ZShyb2xlKVxuXG4gICAgLy8gUmVkc2hpZnRcbiAgICBjb25zdCB2cGMgPSBuZXcgVnBjKHRoaXMsICdSZWRQYW5kYVRlc3RWUEMnLCB7fSlcblxuICAgIGNvbnN0IHNnID0gbmV3IFNlY3VyaXR5R3JvdXAodGhpcywgJ1JlZFBhbmRhVGVzdFNlY3VyaXR5R3JvdXAnLCB7XG4gICAgICB2cGM6IHZwY1xuICAgIH0pXG5cbiAgICBzZy5jb25uZWN0aW9ucy5hbGxvd0Zyb21BbnlJcHY0KFBvcnQudGNwKDU0MzkpKVxuICAgIHNnLm5vZGUuYWRkRGVwZW5kZW5jeSh2cGMpXG5cbiAgICBjb25zdCB7IHN1Ym5ldElkcyB9ID0gdnBjLnNlbGVjdFN1Ym5ldHMoeyBzdWJuZXRUeXBlOiBTdWJuZXRUeXBlLlBVQkxJQyB9KVxuICAgIGNvbnN0IHN1Ym5ldEdyb3VwID0gbmV3IENmbkNsdXN0ZXJTdWJuZXRHcm91cCh0aGlzLCAnUmVkUGFuZGFUZXN0U3VibmV0cycsIHtcbiAgICAgIGRlc2NyaXB0aW9uOiBgU3VibmV0cyBmb3IgUmVkc2hpZnQgY2x1c3RlcmAsXG4gICAgICBzdWJuZXRJZHNcbiAgICB9KVxuXG4gICAgc3VibmV0R3JvdXAuYXBwbHlSZW1vdmFsUG9saWN5KFJlbW92YWxQb2xpY3kuUkVUQUlOLCB7XG4gICAgICBhcHBseVRvVXBkYXRlUmVwbGFjZVBvbGljeTogdHJ1ZVxuICAgIH0pXG5cbiAgICBjb25zdCBjbHVzdGVyID0gbmV3IENmbkNsdXN0ZXIodGhpcywgJ1JlZFBhbmRhVGVzdFJlZHNoaWZ0Jywge1xuICAgICAgbWFzdGVyVXNlcm5hbWU6IHByb2Nlc3MuZW52LlJFRFNISUZUX1VTRVJOQU1FIHx8ICcnLFxuICAgICAgbWFzdGVyVXNlclBhc3N3b3JkOiBwcm9jZXNzLmVudi5SRURTSElGVF9QQVNTV09SRCB8fCAnJyxcbiAgICAgIGRiTmFtZTogcHJvY2Vzcy5lbnYuUkVEU0hJRlRfREIgfHwgJycsXG4gICAgICBjbHVzdGVyVHlwZTogJ3NpbmdsZS1ub2RlJyxcbiAgICAgIHBvcnQ6IHBhcnNlSW50KHByb2Nlc3MuZW52LlJFRFNISUZUX1BPUlQgfHwgJzU0MzknKSxcbiAgICAgIG5vZGVUeXBlOiAnZGMyLmxhcmdlJyxcbiAgICAgIGlhbVJvbGVzOiBbcm9sZS5yb2xlQXJuXSxcbiAgICAgIHB1YmxpY2x5QWNjZXNzaWJsZTogdHJ1ZSxcbiAgICAgIHZwY1NlY3VyaXR5R3JvdXBJZHM6IFtzZy5zZWN1cml0eUdyb3VwSWRdLFxuICAgICAgY2x1c3RlclN1Ym5ldEdyb3VwTmFtZTogc3VibmV0R3JvdXAucmVmXG4gICAgfSlcblxuICAgIGNsdXN0ZXIubm9kZS5hZGREZXBlbmRlbmN5KHNnKVxuXG4gICAgLy8gR2x1ZVxuICAgIGNvbnN0IGdsdWVEQiA9IG5ldyBEYXRhYmFzZSh0aGlzLCAnUmVkUGFuZGFUZXN0R2x1ZURCJywge1xuICAgICAgZGF0YWJhc2VOYW1lOiAncmVkcGFuZGF0ZXN0Z2x1ZWRiJ1xuICAgIH0pXG5cbiAgICBjb25zdCBnbHVlQnVja2V0ID0gbmV3IEJ1Y2tldCh0aGlzLCAnUmVkUGFuZGFUZXN0R2x1ZUJ1Y2tldCcsIHtcbiAgICAgIGJ1Y2tldE5hbWU6IGByZWRwYW5kYXRlc3RzdGFjay1nbHVlLSR7dXVpZHY0KCl9YCxcbiAgICAgIHZlcnNpb25lZDogZmFsc2UsXG4gICAgICBwdWJsaWNSZWFkQWNjZXNzOiBmYWxzZSxcbiAgICAgIGJsb2NrUHVibGljQWNjZXNzOiBCbG9ja1B1YmxpY0FjY2Vzcy5CTE9DS19BTEwsXG4gICAgICByZW1vdmFsUG9saWN5OiBSZW1vdmFsUG9saWN5LkRFU1RST1lcbiAgICB9KVxuXG4gICAgbmV3IFRhYmxlKHRoaXMsICdNeVRhYmxlJywge1xuICAgICAgYnVja2V0OiBnbHVlQnVja2V0LFxuICAgICAgZGF0YWJhc2U6IGdsdWVEQixcbiAgICAgIHRhYmxlTmFtZTogJ3JlZHBhbmRhdGVzdGdsdWV0YWJsZScsXG4gICAgICBjb2x1bW5zOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBuYW1lOiAnY29sMCcsXG4gICAgICAgICAgdHlwZTogU2NoZW1hLlNUUklOR1xuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgbmFtZTogJ2NvbDEnLFxuICAgICAgICAgIHR5cGU6IFNjaGVtYS5TVFJJTkdcbiAgICAgICAgfVxuICAgICAgXSxcbiAgICAgIGRhdGFGb3JtYXQ6IERhdGFGb3JtYXQuQ1NWXG4gICAgfSlcblxuICAgIC8vIEF0aGVuYVxuICAgIG5ldyBCdWNrZXQodGhpcywgJ1JlZFBhbmRhVGVzdEF0aGVuYUJ1Y2tldCcsIHtcbiAgICAgIGJ1Y2tldE5hbWU6IGByZWRwYW5kYXRlc3RzdGFjay1hdGhlbmEtJHt1dWlkdjQoKX1gLFxuICAgICAgdmVyc2lvbmVkOiBmYWxzZSxcbiAgICAgIHB1YmxpY1JlYWRBY2Nlc3M6IGZhbHNlLFxuICAgICAgYmxvY2tQdWJsaWNBY2Nlc3M6IEJsb2NrUHVibGljQWNjZXNzLkJMT0NLX0FMTCxcbiAgICAgIHJlbW92YWxQb2xpY3k6IFJlbW92YWxQb2xpY3kuREVTVFJPWVxuICAgIH0pXG4gIH1cbn1cblxuY29uc3QgYXBwID0gbmV3IEFwcCgpXG5uZXcgUmVkUGFuZGFUZXN0U3RhY2soYXBwLCAnUmVkUGFuZGFUZXN0U3RhY2snKVxuYXBwLnN5bnRoKClcbiJdfQ==